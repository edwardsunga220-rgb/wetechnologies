{% extends 'dashboard_base.html' %}
{% load static %}
{% block dashboard_content %}
<div style="max-width: 900px; margin: 0 auto; padding-bottom: 50px;">
    
    <div style="margin-bottom: 30px;">
        <h2 style="color: #fff; font-family: 'Syne'; margin: 0; font-size: 32px;">{{ title }}</h2>
        <p style="color: rgba(255,255,255,0.5); margin-top: 5px;">Upload and manage portfolio projects with gallery images.</p>
    </div>

    <div class="glass-card fade-in-up" style="padding: 40px; background: rgba(255,255,255,0.02); border-radius: 16px;">
        
        <!-- Success/Error Messages -->
        {% if messages %}
            {% for message in messages %}
            <div style="background: rgba(0, 210, 255, 0.1); border: 1px solid #00d2ff; color: #00d2ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="bi bi-check-circle-fill"></i> {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        {% if form.errors or formset.errors %}
        <div style="background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; color: #ff4757; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <i class="bi bi-exclamation-triangle-fill"></i> Please correct the errors below.
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="project-form">
            {% csrf_token %}
            
            <!-- Basic Information Section -->
            <div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #00d2ff; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-info-circle"></i> Basic Information
                </h3>
                
                <!-- Row 1 -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Project Title *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.title.errors.0 }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Category *</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.category.errors.0 }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Row 2 -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Client Name *</label>
                        {{ form.client_name }}
                        {% if form.client_name.errors %}
                        <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.client_name.errors.0 }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Completion Date *</label>
                        {{ form.completed_date }}
                        {% if form.completed_date.errors %}
                        <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.completed_date.errors.0 }}</span>
                        {% endif %}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Description *</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.description.errors.0 }}</span>
                    {% endif %}
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px; font-weight: 500;">Live Link (Optional)</label>
                    {{ form.live_link }}
                    <small style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 5px; display: block;">Link to the live site or app store</small>
                    {% if form.live_link.errors %}
                    <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.live_link.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Cover Image Section -->
            <div style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: #00d2ff; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-image"></i> Cover Image
                </h3>
                
                <div class="cover-image-upload">
                    <div id="cover-preview-container" style="display: none; margin-bottom: 15px;">
                        <img id="cover-preview" src="" alt="Cover preview" style="max-width: 100%; max-height: 300px; border-radius: 12px; border: 2px solid rgba(0, 210, 255, 0.3);">
                        <button type="button" onclick="clearCoverImage()" style="margin-top: 10px; padding: 8px 16px; background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; color: #ff4757; border-radius: 8px; cursor: pointer; font-size: 12px;">
                            <i class="bi bi-x-circle"></i> Remove Image
                        </button>
                    </div>
                    
                    {% if form.instance.image %}
                    <div style="margin-bottom: 15px;">
                        <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 10px;">Current Image:</p>
                        <img src="{{ form.instance.image.url }}" alt="Current cover" style="max-width: 100%; max-height: 300px; border-radius: 12px; border: 2px solid rgba(0, 210, 255, 0.3);" id="current-cover">
                    </div>
                    {% endif %}
                    
                    <div class="upload-zone" onclick="document.getElementById('id_image').click()" id="cover-upload-zone">
                        <i class="bi bi-cloud-upload" style="font-size: 40px; color: #00d2ff; margin-bottom: 10px; display: block;"></i>
                        <p id="cover-file-label" style="margin: 0; color: rgba(255,255,255,0.7); font-size: 14px;">Click to upload or drag and drop</p>
                        <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.4); font-size: 12px;">PNG, JPG up to 10MB</p>
                    </div>
                    <div style="display: none;">{{ form.image }}</div>
                    {% if form.image.errors %}
                    <span style="color: #ff4757; font-size: 12px; margin-top: 5px; display: block;">{{ form.image.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Gallery Images Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #00d2ff; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-images"></i> Gallery Screenshots
                    <span style="background: rgba(0, 210, 255, 0.2); color: #00d2ff; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: normal;">Optional</span>
                </h3>
                
                {{ formset.management_form }}
                
                <div id="gallery-container">
                    {% for form in formset %}
                    <div class="gallery-item-row" data-form-index="{{ forloop.counter0 }}">
                        {{ form.id }}
                        <div class="gallery-item-content">
                            {% if form.instance.image %}
                            <div class="existing-image-preview">
                                <img src="{{ form.instance.image.url }}" alt="Gallery image">
                                <div class="image-actions">
                                    <span class="image-label">Existing Image</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="gallery-upload-zone">
                                <i class="bi bi-image"></i>
                                <span>{{ form.image }}</span>
                                <p>Click to upload gallery image</p>
                            </div>
                            
                            {% if formset.can_delete and form.instance.pk %}
                            <div class="delete-checkbox">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #ff4757; font-size: 13px;">
                                    {{ form.DELETE }}
                                    <i class="bi bi-trash"></i> Delete
                                </label>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button type="button" onclick="addGalleryRow()" style="margin-top: 15px; padding: 10px 20px; background: rgba(0, 210, 255, 0.1); border: 1px solid #00d2ff; color: #00d2ff; border-radius: 8px; cursor: pointer; font-size: 13px;">
                    <i class="bi bi-plus-circle"></i> Add Another Image
                </button>
            </div>

            <!-- Form Actions -->
            <div style="display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button type="submit" class="btn-primary" style="flex: 1; padding: 15px; background: linear-gradient(90deg, #00d2ff, #3a7bd5); border: none; font-weight: bold; border-radius: 8px; cursor: pointer; color: white; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="bi bi-check-circle"></i> Save Project
                </button>
                <a href="{% url 'dash_projects' %}" style="padding: 15px 30px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: rgba(255,255,255,0.7); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    .cyber-input, select {
        width: 100%; 
        padding: 12px 15px; 
        background: rgba(255,255,255,0.03); 
        border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 8px; 
        color: white;
        font-family: 'Outfit', sans-serif;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .cyber-input:focus, select:focus {
        outline: none;
        border-color: #00d2ff;
        background: rgba(0, 210, 255, 0.05);
        box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.1);
    }
    
    select option { 
        background: #1a1a2e; 
        color: white;
    }
    
    textarea.cyber-input {
        resize: vertical;
        min-height: 100px;
    }
    
    .upload-zone {
        border: 2px dashed rgba(255,255,255,0.1); 
        padding: 40px; 
        text-align: center; 
        border-radius: 12px; 
        cursor: pointer; 
        transition: all 0.3s;
        background: rgba(255,255,255,0.01);
    }
    
    .upload-zone:hover { 
        border-color: #00d2ff; 
        background: rgba(0, 210, 255, 0.05);
        transform: translateY(-2px);
    }
    
    .gallery-item-row {
        margin-bottom: 20px;
        padding: 20px;
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
    }
    
    .gallery-item-content {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: center;
    }
    
    .existing-image-preview {
        position: relative;
        margin-bottom: 15px;
    }
    
    .existing-image-preview img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        border: 2px solid rgba(0, 210, 255, 0.3);
    }
    
    .image-actions {
        margin-top: 8px;
    }
    
    .image-label {
        font-size: 12px;
        color: rgba(255,255,255,0.6);
    }
    
    .gallery-upload-zone {
        position: relative;
        border: 2px dashed rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .gallery-upload-zone:hover {
        border-color: #00d2ff;
        background: rgba(0, 210, 255, 0.05);
    }
    
    .gallery-upload-zone i {
        font-size: 24px;
        color: #00d2ff;
        margin-bottom: 8px;
        display: block;
    }
    
    .gallery-upload-zone span {
        display: block;
    }
    
    .gallery-upload-zone span input[type="file"] {
        width: 100%;
        padding: 8px;
        color: rgba(255,255,255,0.7);
        font-size: 13px;
        cursor: pointer;
    }
    
    .gallery-upload-zone p {
        margin: 8px 0 0 0;
        color: rgba(255,255,255,0.5);
        font-size: 12px;
    }
    
    .delete-checkbox {
        display: flex;
        align-items: center;
    }
    
    .delete-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .fade-in-up { 
        animation: fadeInUp 0.5s ease-out; 
    }
    
    @keyframes fadeInUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
</style>

<script>
    // Cover Image Preview
    document.getElementById('id_image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('cover-preview');
                const container = document.getElementById('cover-preview-container');
                const currentCover = document.getElementById('current-cover');
                
                preview.src = e.target.result;
                container.style.display = 'block';
                if (currentCover) currentCover.style.display = 'none';
                document.getElementById('cover-upload-zone').style.display = 'none';
            };
            reader.readAsDataURL(file);
            document.getElementById('cover-file-label').textContent = file.name;
        }
    });
    
    function clearCoverImage() {
        document.getElementById('id_image').value = '';
        document.getElementById('cover-preview-container').style.display = 'none';
        document.getElementById('cover-upload-zone').style.display = 'block';
        const currentCover = document.getElementById('current-cover');
        if (currentCover) currentCover.style.display = 'block';
        document.getElementById('cover-file-label').textContent = 'Click to upload or drag and drop';
    }
    
    // Gallery Image Preview
    document.querySelectorAll('#gallery-container input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = input.closest('.gallery-item-row');
                    let preview = row.querySelector('.gallery-preview');
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.className = 'gallery-preview';
                        preview.style.cssText = 'max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid rgba(0, 210, 255, 0.3); margin-bottom: 10px;';
                        input.parentElement.parentElement.insertBefore(preview, input.parentElement);
                    }
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    });
    
    // Add new gallery row (Note: This requires dynamic formset handling - for now it's a placeholder)
    function addGalleryRow() {
        alert('To add more gallery images, please save the project first and then edit it to add additional images.');
    }
</script>
{% endblock %}