{% extends 'dashboard_base.html' %}
{% load static %}
{% block dashboard_content %}
<div style="max-width: 1400px; margin: 0 auto; padding-bottom: 50px;">
    
    <!-- Header -->
    <div class="email-header">
        <div>
            <h2 style="color: #fff; font-family: 'Syne'; margin: 0; font-size: 32px;">Email Composer</h2>
            <p style="color: rgba(255,255,255,0.6); margin-top: 5px;">Compose and send emails to your clients</p>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="email-stats-grid">
        <div class="glass-card stat-card-small">
            <div class="stat-icon-small" style="background: rgba(0, 210, 255, 0.1); color: #00d2ff;">
                <i class="bi bi-envelope-check"></i>
            </div>
            <div>
                <div class="stat-value-small">{{ total_sent }}</div>
                <div class="stat-label-small">Total Sent</div>
            </div>
        </div>
        <div class="glass-card stat-card-small">
            <div class="stat-icon-small" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71;">
                <i class="bi bi-calendar-day"></i>
            </div>
            <div>
                <div class="stat-value-small">{{ sent_today }}</div>
                <div class="stat-label-small">Sent Today</div>
            </div>
        </div>
        <div class="glass-card stat-card-small">
            <div class="stat-icon-small" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">
                <i class="bi bi-calendar-week"></i>
            </div>
            <div>
                <div class="stat-value-small">{{ sent_this_week }}</div>
                <div class="stat-label-small">This Week</div>
            </div>
        </div>
        <div class="glass-card stat-card-small">
            <div class="stat-icon-small" style="background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
                <i class="bi bi-calendar-month"></i>
            </div>
            <div>
                <div class="stat-value-small">{{ sent_this_month }}</div>
                <div class="stat-label-small">This Month</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="email-main-grid">
        
        <!-- Left Sidebar: Templates & Quick Actions -->
        <div class="email-sidebar">
            
            <!-- Email Templates -->
            <div class="sidebar-section glass-card">
                <div class="sidebar-header">
                    <h3><i class="bi bi-file-earmark-text"></i> Email Templates</h3>
                    <button type="button" class="icon-btn" onclick="toggleTemplates()" title="Toggle Templates">
                        <i class="bi bi-chevron-down" id="templates-icon"></i>
                    </button>
                </div>
                <div class="templates-list" id="templates-list">
                    {% for template in templates %}
                    <div class="template-item" data-template-id="{{ template.id }}" onclick="loadTemplateFromData(this)">
                        <div class="template-icon">
                            <i class="bi bi-file-text"></i>
                        </div>
                        <div class="template-info">
                            <strong>{{ template.name }}</strong>
                            <small>{{ template.get_category_display }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">No templates yet</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Contacts -->
            <div class="sidebar-section glass-card">
                <div class="sidebar-header">
                    <h3><i class="bi bi-people"></i> Recent Contacts</h3>
                    <button type="button" class="icon-btn" onclick="toggleContacts()" title="Toggle Contacts">
                        <i class="bi bi-chevron-down" id="contacts-icon"></i>
                    </button>
                </div>
                <div class="contacts-list" id="contacts-list">
                    {% for client in clients|slice:":10" %}
                    <div class="contact-item" onclick="selectClient('{{ client.contact_info }}', '{{ client.name|escapejs }}', {{ client.id }})">
                        <div class="contact-avatar">{{ client.name|slice:":1"|upper }}</div>
                        <div class="contact-info">
                            <strong>{{ client.name }}</strong>
                            <small>{{ client.contact_info }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">No contacts yet</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="sidebar-section glass-card">
                <div class="sidebar-header">
                    <h3><i class="bi bi-lightning"></i> Quick Actions</h3>
                </div>
                <div class="quick-actions">
                    <button type="button" class="quick-action-btn" onclick="insertVariable('name')">
                        <i class="bi bi-person"></i> {{name}}
                    </button>
                    <button type="button" class="quick-action-btn" onclick="insertVariable('product')">
                        <i class="bi bi-box"></i> {{product}}
                    </button>
                    <button type="button" class="quick-action-btn" onclick="insertVariable('date')">
                        <i class="bi bi-calendar"></i> {{date}}
                    </button>
                    <button type="button" class="quick-action-btn" onclick="insertVariable('company')">
                        <i class="bi bi-building"></i> {{company}}
                    </button>
                </div>
            </div>

        </div>

        <!-- Main Composer Area -->
        <div class="email-composer-area">
            
            <!-- Composer Form -->
            <div class="composer-card glass-card">
                {% if messages %}
                {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
                    <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-exclamation-circle-fill{% endif %}"></i>
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}

                <form method="POST" id="email-form">
                    {% csrf_token %}
                    
                    <!-- Recipient Selection -->
                    <div class="form-group">
                        <label>
                            <i class="bi bi-person"></i> Recipient <span class="required">*</span>
                        </label>
                        <div class="recipient-input-wrapper">
                            <input type="email" name="recipient" id="recipient-email" class="cyber-input" 
                                   value="{{ request.GET.to|default:'' }}" 
                                   placeholder="client@example.com" required>
                            <input type="hidden" name="client_id" id="client-id">
                            <input type="hidden" name="recipient_name" id="recipient-name">
                            <button type="button" class="btn-select-client" onclick="openClientSelector()" title="Select Client">
                                <i class="bi bi-people"></i>
                            </button>
                        </div>
                        <small class="field-hint" id="recipient-hint">Select a client or enter email manually</small>
                    </div>

                    <!-- Subject -->
                    <div class="form-group">
                        <label>
                            <i class="bi bi-tag"></i> Subject <span class="required">*</span>
                        </label>
                        <input type="text" name="subject" id="email-subject" class="cyber-input" 
                               value="{% if request.GET.product %}Regarding your interest in {{ request.GET.product }}{% endif %}"
                               placeholder="Enter email subject..." required>
                        <small class="field-hint" id="subject-counter">0 characters</small>
                    </div>

                    <!-- Message Body with Rich Text Editor -->
                    <div class="form-group">
                        <label>
                            <i class="bi bi-chat-left-text"></i> Message <span class="required">*</span>
                        </label>
                        <div class="editor-toolbar">
                            <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Underline">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <div class="toolbar-divider"></div>
                            <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                <i class="bi bi-list-ul"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">
                                <i class="bi bi-list-ol"></i>
                            </button>
                            <div class="toolbar-divider"></div>
                            <button type="button" class="toolbar-btn" onclick="formatText('createLink')" title="Insert Link">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                        </div>
                        <div contenteditable="true" id="email-message-editor" class="message-editor" 
                             data-placeholder="Type your message here..."></div>
                        <textarea name="message" id="email-message" class="cyber-input" style="display:none;" required></textarea>
                        <small class="field-hint" id="message-counter">0 words</small>
                    </div>

                    <!-- Additional Options -->
                    <div class="form-options">
                        <label class="option-toggle">
                            <input type="checkbox" name="save_template" id="save-template">
                            <span>Save as template</span>
                        </label>
                        <label class="option-toggle">
                            <input type="checkbox" name="send_copy" id="send-copy">
                            <span>Send copy to me</span>
                        </label>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="saveDraft()">
                            <i class="bi bi-save"></i> Save Draft
                        </button>
                        <button type="button" class="btn-preview" onclick="togglePreview()">
                            <i class="bi bi-eye"></i> Preview
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-send-fill"></i> Send Email
                        </button>
                    </div>
                </form>
            </div>

            <!-- Email History -->
            <div class="history-card glass-card">
                <div class="history-header">
                    <h3><i class="bi bi-clock-history"></i> Recent Emails</h3>
                    <button type="button" class="icon-btn" onclick="toggleHistory()" title="Toggle History">
                        <i class="bi bi-chevron-down" id="history-icon"></i>
                    </button>
                </div>
                <div class="history-list" id="history-list">
                    {% for email in sent_emails|slice:":10" %}
                    <div class="history-item">
                        <div class="history-icon">
                            <i class="bi bi-envelope{% if email.status == 'sent' %}-check{% elif email.status == 'failed' %}-x{% endif %}"></i>
                        </div>
                        <div class="history-info">
                            <strong>{{ email.recipient_name|default:email.recipient }}</strong>
                            <small>{{ email.subject|truncatechars:50 }}</small>
                            <span class="history-time">{{ email.sent_at|timesince }} ago</span>
                        </div>
                        <button type="button" class="history-action" onclick="viewEmailHistory({{ email.id }})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% empty %}
                    <div class="empty-state">No emails sent yet</div>
                    {% endfor %}
                </div>
            </div>

        </div>

        <!-- Right Sidebar: Preview Panel -->
        <div class="email-preview-sidebar" id="preview-sidebar" style="display: none;">
            <div class="preview-header">
                <h3><i class="bi bi-eye"></i> Email Preview</h3>
                <button type="button" class="icon-btn" onclick="togglePreview()" title="Close Preview">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="preview-content">
                <div class="preview-device-toggle">
                    <button type="button" class="device-btn active" data-device="desktop" onclick="switchPreviewDevice('desktop', this)">
                        <i class="bi bi-laptop"></i> Desktop
                    </button>
                    <button type="button" class="device-btn" data-device="mobile" onclick="switchPreviewDevice('mobile', this)">
                        <i class="bi bi-phone"></i> Mobile
                    </button>
                </div>
                <div class="preview-frame" id="preview-frame">
                    <div class="email-preview-content" id="email-preview-content">
                        <div class="preview-placeholder">Preview will appear here</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Client Selector Modal -->
<div id="client-selector-modal" class="modal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2>Select Client</h2>
            <button type="button" class="modal-close" onclick="closeClientSelector()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-wrapper">
                <i class="bi bi-search"></i>
                <input type="text" id="client-search-input" placeholder="Search clients..." class="search-input" oninput="filterClients(this.value)">
            </div>
            <div class="clients-selector-list" id="clients-selector-list">
                {% for client in clients %}
                <div class="client-selector-item" onclick="selectClient('{{ client.contact_info }}', '{{ client.name|escapejs }}', {{ client.id }})">
                    <div class="client-selector-avatar">{{ client.name|slice:":1"|upper }}</div>
                    <div class="client-selector-info">
                        <strong>{{ client.name }}</strong>
                        <small>{{ client.contact_info }}</small>
                        <span class="client-selector-product">{{ client.product_interested }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">No clients found</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Email History View Modal -->
<div id="email-history-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Email Details</h2>
            <button type="button" class="modal-close" onclick="closeEmailHistory()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body" id="email-history-content">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<style>
/* Email Page Styles */
.email-header {
    margin-bottom: 30px;
}

.email-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card-small {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
}

.stat-icon-small {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-value-small {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    font-family: 'Syne', sans-serif;
}

.stat-label-small {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Main Grid Layout */
.email-main-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 25px;
}

.email-preview-sidebar.active {
    grid-template-columns: 300px 1fr 400px;
}

/* Sidebar Styles */
.email-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-section {
    padding: 20px;
    border-radius: 16px;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.sidebar-header h3 {
    color: #fff;
    font-size: 16px;
    font-family: 'Syne', sans-serif;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.icon-btn {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    transition: 0.3s;
}

.icon-btn:hover {
    color: #00d2ff;
}

/* Templates List */
.templates-list, .contacts-list {
    max-height: 300px;
    overflow-y: auto;
}

.template-item, .contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    margin-bottom: 8px;
}

.template-item:hover, .contact-item:hover {
    background: rgba(0, 210, 255, 0.1);
}

.template-icon, .contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00d2ff, #7000ff);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.template-info, .contact-info {
    flex: 1;
}

.template-info strong, .contact-info strong {
    display: block;
    color: #fff;
    font-size: 14px;
    margin-bottom: 4px;
}

.template-info small, .contact-info small {
    color: rgba(255,255,255,0.5);
    font-size: 12px;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.quick-action-btn {
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    font-size: 12px;
    transition: 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
    justify-content: center;
}

.quick-action-btn:hover {
    background: rgba(0, 210, 255, 0.1);
    border-color: #00d2ff;
    color: #00d2ff;
}

/* Composer Card */
.composer-card {
    padding: 30px;
    margin-bottom: 20px;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-success {
    background: rgba(46, 204, 113, 0.15);
    border: 1px solid rgba(46, 204, 113, 0.3);
    color: #2ecc71;
}

.alert-error {
    background: rgba(231, 76, 60, 0.15);
    border: 1px solid rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.9);
    font-weight: 500;
    margin-bottom: 10px;
    font-size: 14px;
}

.required {
    color: #ff4757;
}

.field-hint {
    display: block;
    color: rgba(255,255,255,0.4);
    font-size: 12px;
    margin-top: 6px;
}

/* Recipient Input */
.recipient-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: center;
}

.recipient-input-wrapper .cyber-input {
    flex: 1;
}

.btn-select-client {
    padding: 12px 16px;
    background: rgba(0, 210, 255, 0.1);
    border: 1px solid rgba(0, 210, 255, 0.3);
    border-radius: 8px;
    color: #00d2ff;
    cursor: pointer;
    transition: 0.3s;
}

.btn-select-client:hover {
    background: rgba(0, 210, 255, 0.2);
}

/* Editor Toolbar */
.editor-toolbar {
    display: flex;
    gap: 5px;
    padding: 10px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
}

.toolbar-btn {
    width: 36px;
    height: 36px;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}

.toolbar-btn:hover {
    background: rgba(0, 210, 255, 0.1);
    border-color: #00d2ff;
    color: #00d2ff;
}

.toolbar-divider {
    width: 1px;
    background: rgba(255,255,255,0.1);
    margin: 0 5px;
}

/* Message Editor */
.message-editor {
    min-height: 300px;
    padding: 20px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-top: none;
    border-radius: 0 0 8px 8px;
    color: #fff;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    line-height: 1.6;
    outline: none;
}

.message-editor:empty::before {
    content: attr(data-placeholder);
    color: rgba(255,255,255,0.4);
}

.message-editor:focus {
    border-color: #00d2ff;
}

/* Form Options */
.form-options {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
}

.option-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.8);
    font-size: 14px;
    cursor: pointer;
}

.option-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #00d2ff;
}

/* Form Actions */
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.btn-secondary, .btn-preview, .btn-primary {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: 0.3s;
}

.btn-secondary {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
}

.btn-preview {
    background: rgba(52, 152, 219, 0.2);
    border: 1px solid rgba(52, 152, 219, 0.3);
    color: #3498db;
}

.btn-primary {
    background: linear-gradient(90deg, #00d2ff, #7000ff);
    color: #fff;
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.15);
}

.btn-preview:hover {
    background: rgba(52, 152, 219, 0.3);
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 210, 255, 0.3);
}

/* History Card */
.history-card {
    padding: 20px;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.history-header h3 {
    color: #fff;
    font-size: 16px;
    font-family: 'Syne', sans-serif;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.history-list {
    max-height: 400px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: 0.3s;
}

.history-item:hover {
    background: rgba(255,255,255,0.03);
}

.history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(0, 210, 255, 0.1);
    color: #00d2ff;
    display: flex;
    align-items: center;
    justify-content: center;
}

.history-info {
    flex: 1;
}

.history-info strong {
    display: block;
    color: #fff;
    font-size: 14px;
    margin-bottom: 4px;
}

.history-info small {
    display: block;
    color: rgba(255,255,255,0.5);
    font-size: 12px;
}

.history-time {
    color: rgba(255,255,255,0.4);
    font-size: 11px;
}

.history-action {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
}

.history-action:hover {
    color: #00d2ff;
}

/* Preview Sidebar */
.email-preview-sidebar {
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.preview-header h3 {
    color: #fff;
    font-size: 16px;
    font-family: 'Syne', sans-serif;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-content {
    padding: 20px;
}

.preview-device-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.device-btn {
    flex: 1;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: rgba(255,255,255,0.7);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: 0.3s;
}

.device-btn.active {
    background: rgba(0, 210, 255, 0.2);
    border-color: #00d2ff;
    color: #00d2ff;
}

.preview-frame {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    min-height: 500px;
}

.preview-frame.desktop {
    width: 100%;
}

.preview-frame.mobile {
    width: 375px;
    margin: 0 auto;
}

.email-preview-content {
    padding: 30px;
    color: #333;
    font-family: 'Outfit', sans-serif;
}

.preview-placeholder {
    text-align: center;
    color: #999;
    padding: 50px;
}

.empty-state {
    text-align: center;
    color: rgba(255,255,255,0.4);
    padding: 30px;
    font-size: 14px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: #1a1a2e;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-medium {
    max-width: 600px;
}

.modal-large {
    max-width: 900px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.modal-header h2 {
    margin: 0;
    color: #fff;
    font-family: 'Syne', sans-serif;
}

.modal-close {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.7);
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: 0.3s;
}

.modal-close:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
}

.modal-body {
    padding: 30px;
}

/* Client Selector */
.search-wrapper {
    position: relative;
    margin-bottom: 20px;
}

.search-wrapper i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255,255,255,0.4);
}

.search-input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
}

.clients-selector-list {
    max-height: 500px;
    overflow-y: auto;
}

.client-selector-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    margin-bottom: 10px;
}

.client-selector-item:hover {
    background: rgba(0, 210, 255, 0.1);
}

.client-selector-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00d2ff, #7000ff);
    color: #fff;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.client-selector-info {
    flex: 1;
}

.client-selector-info strong {
    display: block;
    color: #fff;
    font-size: 16px;
    margin-bottom: 4px;
}

.client-selector-info small {
    display: block;
    color: rgba(255,255,255,0.6);
    font-size: 13px;
    margin-bottom: 4px;
}

.client-selector-product {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(0, 210, 255, 0.1);
    border: 1px solid rgba(0, 210, 255, 0.3);
    border-radius: 12px;
    color: #00d2ff;
    font-size: 11px;
}

/* Cyber Input Styles */
.cyber-input {
    width: 100%;
    padding: 12px 15px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: white;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    outline: none;
    transition: 0.3s;
}

.cyber-input:focus {
    border-color: #00d2ff;
    background: rgba(0, 210, 255, 0.05);
}

/* Responsive */
@media (max-width: 1200px) {
    .email-main-grid {
        grid-template-columns: 1fr;
    }
    .email-sidebar {
        order: 2;
    }
    .email-preview-sidebar {
        position: relative;
        top: 0;
    }
}

@media (max-width: 768px) {
    .email-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .form-actions {
        flex-direction: column;
    }
    .form-actions button {
        width: 100%;
    }
}
</style>

<script>
// Template and Client Management
const templates = {
    {% for template in templates %}
    {{ template.id }}: {
        name: "{{ template.name|escapejs }}",
        subject: "{{ template.subject|escapejs }}",
        body: `{{ template.body|escapejs }}`
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

const clients = {
    {% for client in clients %}
    {{ client.id }}: {
        name: "{{ client.name|escapejs }}",
        email: "{{ client.contact_info|escapejs }}",
        product: "{{ client.product_interested|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Load Template
function loadTemplate(templateId, subject, body) {
    document.getElementById('email-subject').value = subject;
    document.getElementById('email-message-editor').innerHTML = body.replace(/\n/g, '<br>');
    updateMessageField();
    updateCounters();
}

// Load Template from Data Attributes
function loadTemplateFromData(element) {
    const templateId = parseInt(element.dataset.templateId);
    if (templates[templateId]) {
        const template = templates[templateId];
        loadTemplate(templateId, template.subject, template.body);
    }
}

// Select Client
function selectClient(email, name, clientId) {
    document.getElementById('recipient-email').value = email;
    document.getElementById('recipient-name').value = name;
    document.getElementById('client-id').value = clientId;
    document.getElementById('recipient-hint').textContent = 'Selected: ' + name;
    closeClientSelector();
    
    // If client has product interest, suggest in subject
    if (clientId && clients[clientId] && clients[clientId].product) {
        const currentSubject = document.getElementById('email-subject').value;
        if (!currentSubject || currentSubject.trim() === '') {
            document.getElementById('email-subject').value = 'Regarding your interest in ' + clients[clientId].product;
            updateCounters();
        }
    }
}

// Client Selector Modal
function openClientSelector() {
    document.getElementById('client-selector-modal').style.display = 'flex';
}

function closeClientSelector() {
    document.getElementById('client-selector-modal').style.display = 'none';
}

function filterClients(searchTerm) {
    const items = document.querySelectorAll('.client-selector-item');
    const term = searchTerm.toLowerCase();
    items.forEach(function(item) {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? '' : 'none';
    });
}

// Insert Variable
function insertVariable(varName) {
    const editor = document.getElementById('email-message-editor');
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const textNode = document.createTextNode('{{' + varName + '}}');
    range.deleteContents();
    range.insertNode(textNode);
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
    editor.focus();
    updateMessageField();
}

// Format Text
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('email-message-editor').focus();
}

// Update Message Field
function updateMessageField() {
    const editor = document.getElementById('email-message-editor');
    const textarea = document.getElementById('email-message');
    textarea.value = editor.innerText;
    updateCounters();
}

// Update Counters
function updateCounters() {
    const subject = document.getElementById('email-subject').value;
    const message = document.getElementById('email-message-editor').innerText;
    
    document.getElementById('subject-counter').textContent = subject.length + ' characters';
    
    const wordCount = message.trim().split(/\s+/).filter(function(word) { return word.length > 0; }).length;
    document.getElementById('message-counter').textContent = wordCount + ' words';
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('email-message-editor');
    const subject = document.getElementById('email-subject');
    
    editor.addEventListener('input', updateMessageField);
    subject.addEventListener('input', updateCounters);
    
    // Initial content from URL params
    {% if request.GET.name %}
    const initialMessage = `Hello {{ request.GET.name|escapejs }},\n\nThank you for contacting WeTech regarding {{ request.GET.product|escapejs }}...`;
    editor.innerHTML = initialMessage.replace(/\n/g, '<br>');
    updateMessageField();
    {% endif %}
    
    updateCounters();
});

// Save Draft
function saveDraft() {
    const subject = document.getElementById('email-subject').value;
    const message = document.getElementById('email-message-editor').innerText;
    localStorage.setItem('email_draft_subject', subject);
    localStorage.setItem('email_draft_message', message);
    alert('Draft saved locally!');
}

// Load Draft
function loadDraft() {
    const subject = localStorage.getItem('email_draft_subject');
    const message = localStorage.getItem('email_draft_message');
    if (subject) document.getElementById('email-subject').value = subject;
    if (message) {
        document.getElementById('email-message-editor').innerHTML = message.replace(/\n/g, '<br>');
        updateMessageField();
    }
}

// Toggle Sections
function toggleTemplates() {
    const list = document.getElementById('templates-list');
    const icon = document.getElementById('templates-icon');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        list.style.display = 'none';
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

function toggleContacts() {
    const list = document.getElementById('contacts-list');
    const icon = document.getElementById('contacts-icon');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        list.style.display = 'none';
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

function toggleHistory() {
    const list = document.getElementById('history-list');
    const icon = document.getElementById('history-icon');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        list.style.display = 'none';
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

// Preview
let previewDevice = 'desktop';

function togglePreview() {
    const sidebar = document.getElementById('preview-sidebar');
    const grid = document.querySelector('.email-main-grid');
    if (sidebar.style.display === 'none' || sidebar.style.display === '') {
        sidebar.style.display = 'block';
        grid.style.gridTemplateColumns = '300px 1fr 400px';
        updatePreview();
    } else {
        sidebar.style.display = 'none';
        grid.style.gridTemplateColumns = '300px 1fr';
    }
}

function switchPreviewDevice(device, btn) {
    previewDevice = device;
    document.querySelectorAll('.device-btn').forEach(function(b) {
        b.classList.remove('active');
    });
    btn.classList.add('active');
    
    const frame = document.getElementById('preview-frame');
    frame.className = 'preview-frame ' + device;
    updatePreview();
}

function updatePreview() {
    const subject = document.getElementById('email-subject').value || 'Email Subject';
    const message = document.getElementById('email-message-editor').innerHTML || '<p>Email content will appear here</p>';
    const recipient = document.getElementById('recipient-email').value || 'recipient@example.com';
    
    const previewContent = `
        <div style="padding: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px;">
            <strong>To:</strong> ${recipient}<br>
            <strong>Subject:</strong> ${subject}
        </div>
        <div style="line-height: 1.6;">
            ${message}
        </div>
    `;
    
    document.getElementById('email-preview-content').innerHTML = previewContent;
}

// Form Submit Handler
document.getElementById('email-form').addEventListener('submit', function(e) {
    const editor = document.getElementById('email-message-editor');
    const textarea = document.getElementById('email-message');
    
    // Convert HTML to plain text for email
    textarea.value = editor.innerText;
});

// Email History View
function viewEmailHistory(emailId) {
    // This would require an AJAX call to get email details
    // For now, just show an alert
    alert('Email history details view would be implemented here with AJAX call to backend.');
}

function closeEmailHistory() {
    document.getElementById('email-history-modal').style.display = 'none';
}

// Close modals on outside click
window.onclick = function(event) {
    const clientModal = document.getElementById('client-selector-modal');
    const historyModal = document.getElementById('email-history-modal');
    
    if (event.target == clientModal) {
        closeClientSelector();
    }
    if (event.target == historyModal) {
        closeEmailHistory();
    }
};

// Load draft on page load if exists
window.addEventListener('load', function() {
    {% if not request.GET.to %}
    loadDraft();
    {% endif %}
});
</script>
{% endblock %}
